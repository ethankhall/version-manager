machine:
    java:
        version: oraclejdk8
    services:
        - docker
        - mysql
    node:
        version: 7.2.1 
    environment:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost/circle_test
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: password
        SPRING_DATASOURCE_DBNAME: circle_test
    pre:
        # Stop the preinstalled MySQL 5.6
        - sudo service mysql stop

dependencies:
    pre:
        - >
          docker run
          --detach
          --name mysql
          --publish 3306:3306
          --env MYSQL_ALLOW_EMPTY_PASSWORD='yes'
          --env MYSQL_DATABASE=circle_test
          --env MYSQL_ROOT_PASSWORD=password
          mysql:5.7.11
          ; sleep 10
    override:
        - ./gradlew resolveDependencies --console=plain
        - bin/fix-ci-vm.sh

test:
    override:
        - ./gradlew --stop
        - ./gradlew check --console=plain

    post:
        - mkdir -p $CIRCLE_TEST_REPORTS/junit
        - find build -maxdepth 5 -name 'TEST-*.xml' -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

        - mkdir -p $CIRCLE_ARTIFACTS/coverage
        - cp -r build/reports/jacoco/testCoverage/* $CIRCLE_ARTIFACTS/coverage

deployment:
    master:
        branch: master
        commands:
            - echo $GOOGLE_CLIENT_SECRET | base64 --decode > ${HOME}/client-secret.json
            - gcloud auth activate-service-account --key-file ${HOME}/client-secret.json
            - gcloud config set project $GCLOUD_PROJECT
            - docker login -e 1234@5678.com -u _json_key -p "$(cat ${HOME}/client-secret.json)" https://us.gcr.io
            - ./gradlew claimVersion --refresh-dependencies  --console=plain
            - ./gradlew clean :docker:pushContainers --console=plain
