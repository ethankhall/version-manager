machine:
    java:
        version: oraclejdk8
    services:
        - docker
        - postgresql
    environment:
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost/circle_test
        SPRING_DATASOURCE_USERNAME: ubuntu
        SPRING_DATASOURCE_PASSWORD:

dependencies:
    override:
        - docker pull java:8
        - ./gradlew resolveDependencies --console=plain

database:
    pre:
        - psql -U ubuntu circle_test --command 'CREATE EXTENSION "uuid-ossp";'

test:
    override:
        - ./gradlew --stop
        - ./gradlew check --console=plain
        - ./gradlew asciidoctor --console=plain

    post:
        - mkdir -p "$CIRCLE_ARTIFACTS/docs"
        - cp -r build/docs/asciidoc/html5 "$CIRCLE_ARTIFACTS/docs"

        - mkdir -p "$CIRCLE_ARTIFACTS/junit"
        - find build -maxdepth 5 -name 'TEST-*.xml' -exec cp {} "$CIRCLE_ARTIFACTS/junit/" \;

        - mkdir -p "$CIRCLE_ARTIFACTS/coverage"
        - cp -r build/reports/jacoco/testCoverage/* "$CIRCLE_ARTIFACTS/coverage"

deployment:
    hub:
        branch: master
        commands:
            - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS ehdev-docker-dockerv2-local.artifactoryonline.com:443
            - ./gradlew copyFileIntoDockerDir --console=plain
            - docker build -t ethankhall/conrad-webapp .
            - docker tag ethankhall/conrad-webapp ehdev-docker-dockerv2-local.artifactoryonline.com/ethankhall/conrad-webapp
            - docker push ehdev-docker-dockerv2-local.artifactoryonline.com/ethankhall/conrad-webapp
